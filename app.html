<html>
<body>
  <img src="perfect-loop-lego.gif">
  <div id="output">

  </div>

  <script>
    function output(text) {
      document.getElementById('output').innerHTML += text + '<br>'
    }

    /* Commands
      db.setItem(key, value, (err) => { if (err) console.error(err) })
      db.getItem(key, (res, err) => { err ? console.error(err) : console.log(res) })
      db.removeItem(key, (err) => { if (err) console.error(err) })
    */

    let totalRuns = 1000
    let db = require('./db.js')
    let db_sw = require('./db-sw.js')

    output('total runs: ' + totalRuns)

    db.init(window, function (err) {
      if (err) output(err)
      normalTestSync()
    })

    function normalTestSync() {
      let start = new Date().getTime()

      function test(runNumber, runs) {
        db.setItem('setItem' + runNumber, 'hello worker' + runNumber, function (err) {
          if (err) console.error(err)
          if (runNumber < runs) test(++runNumber, runs)
          else {
            let end = new Date().getTime()
            output(`setItem Sync: ${(end - start)/totalRuns}ms avg, ${end - start}ms total`)
            setTimeout(normalTestAsync, 2000)
          }
        })
      }
      test(1,totalRuns)
    }

    function normalTestAsync() {
      let totalComplete = 0

      let start = new Date().getTime()
      for (let i = 0; i < totalRuns; i++) {
        db.setItem('AsyncSetItem' + i, 'blah' + i, function (err) {
          if (err) console.error(err)
          totalComplete++
          checkDone()
        })
      }

      function checkDone() {
        if (totalComplete === totalRuns) {
          let end = new Date().getTime()
          output(`setItem Async: ${(end - start)/totalRuns}ms avg, ${end - start}ms total`)
          setTimeout(swInit, 2000)
        }
      }
    }

    function swInit() {
      let initStart = new Date().getTime()
      db_sw.init(window, function (err) {
        if (err) console.error(err)
        let end = new Date().getTime()
        output(`sharedWorker init time: ${end - initStart}ms`)
        setTimeout(serviceTestSync, 2000)
      })
    }

    function serviceTestSync() {
      let start = new Date().getTime()

      function test(runNumber) {
        db_sw.setItem('swTest' + runNumber, 'hello sharedworker' + runNumber, function (err) {
          console.log('Sync: ' + runNumber + '/' + totalRuns)
          if (err) console.error(err)
          if (runNumber < totalRuns) test(++runNumber)
          else {
            let end = new Date().getTime()
            output(`sharedWorker setItem Sync: ${(end - start)/totalRuns}ms avg, ${end - start}ms total`)
            setTimeout(serviceTestAsync, 2000)
          }
        })
      }
      test(1)
    }

    function serviceTestAsync() {
      let totalComplete = 0

      let start = new Date().getTime()
      for (let i = 0; i < totalRuns; i++) {
        db_sw.setItem('swAsyncSetItem' + i, 'blah' + i, function (err) {
          if (err) console.error(err)
          totalComplete++
          checkDone(i)
        })
      }

      function checkDone(run) {
        console.log('Async: ' + totalComplete + '/' + totalRuns)
        if (totalComplete === totalRuns) {
          let end = new Date().getTime()
          output(`sharedWorker setItem Async: ${(end - start)/totalRuns}ms avg, ${end - start}ms total`)
        }
      }
    }

  </script>
</body>
</html>
